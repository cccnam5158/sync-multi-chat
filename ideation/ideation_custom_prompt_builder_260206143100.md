# Custom Prompt Builder기능 설명서

> 참고 자료: `custom-prompt-builder-proposed-html.html` 
> 작성일: 2026-02-06

---

## 0. 목적과 범위

이 기능은 **Cross Check의 Custom 프롬프트를 로컬에서 관리**하고(저장/검색/정렬/복제/삭제), 프롬프트 내 `{{변수}}`를 **시스템/전역/개별 변수로 치환**하여 **최종 전송 전 결과를 미리보기(프리뷰 모달 포함)** 할 수 있는 **Prompt Builder**의 기능 설명서 입니다.

- 데이터 저장: 브라우저 **localStorage**(서버/로그인 없이 동작)
- 전송: 실제 API 호출 대신, **치환된 최종 텍스트를 ‘Cross Check 전송 프리뷰’ 모달**로 제공

---

## 1. 화면 구성(Information Architecture)

### 1.1 3단 레이아웃
- **좌측: Saved Prompts 사이드바**  
  프롬프트 목록/검색/정렬, 신규 생성, Import/Export 제공
- **중앙: Editor**  
  Edit/Preview 탭, 텍스트 편집, 변수 자동완성/삽입, 정리(포맷) 제공
- **우측: Variables 패널**  
  전역/개별/시스템 변수를 탭으로 관리 및 삽입

### 1.2 상단 바(Topbar)
- 좌측: 앱/페이지 타이틀 + 저장 상태(저장됨/미저장 변경) + 생성/업데이트 메타
- 중앙: 현재 프롬프트 제목 입력
- 우측: Save / Preview / Send / More(⋯) 액션

---

## 2. 프롬프트 관리(Prompt Management)

### 2.1 프롬프트 CRUD
1) **새 프롬프트 생성 (+ New, Alt+N)**  
- 빈 프롬프트를 생성하고 편집 모드로 진입합니다.  
- 현재 프롬프트에 미저장 변경이 있으면 이동 전 확인(저장 여부 확인)을 수행합니다.

2) **저장 (Save, Ctrl+S)**  
- 현재 프롬프트의 **제목/내용/개별 변수(localVars)** 를 저장하고 `updatedAt`을 갱신합니다.  
- 변경 사항이 없으면 Save 버튼은 비활성화됩니다.

3) **복제 (Duplicate, Alt+D)**  
- 현재 프롬프트를 깊은 복사하여 새 항목을 생성합니다.  
- 제목에 “(복제)” 접미사를 부여합니다.

4) **삭제 (Delete, Alt+Backspace)**  
- 확인 다이얼로그 후 삭제를 수행합니다.  
- 삭제 후에는 목록의 첫 번째 프롬프트로 전환합니다.

### 2.2 프롬프트 목록(사이드바)
- **카드 형태 목록 표시**: 제목, 내용 미리보기(약 80자), 업데이트 일시, 마지막 사용 일시(`lastUsedAt`)  
- **검색 필터링(실시간)**: 제목/내용에 대해 입력 즉시 필터링. 결과 없으면 “검색 결과가 없습니다” 표시  
- **정렬 토글**:  
  - “정렬: 최근” = 업데이트 시간 기준 내림차순  
  - “정렬: 제목” = 한국어 로케일 기준 사전순
- **미저장 전환 가드**: 다른 프롬프트로 이동 시 미저장 변경이 있으면 “저장하고 이동할까요?” 확인

### 2.3 Import / Export (JSON)
- **Export**: 현재 저장된 전체 프롬프트 + 전역 변수를 `smc-prompts-export.json`로 다운로드  
  - `version`, `exportedAt` 등 메타 포함
- **Import**: JSON 파일로부터 데이터를 가져와 덮어쓰기  
  - `prompts`, `globalVars` 키 존재 여부 등 형식 검증  
  - 덮어쓰기 전 확인 다이얼로그 제공

> 참고: Import는 “병합(merge)”이 아니라 **덮어쓰기(overwrite)** 동작에 초점이 맞춰져 있습니다.

---

## 3. 에디터(Editor)

### 3.1 텍스트 편집
- 코드 스타일 **모노스페이스 textarea** 기반 편집기
- 제목 입력(Topbar 중앙)에서 즉시 변경 가능
- 입력 변경 시 **dirty 상태**로 전환(상단 상태 도트/텍스트 반영)

### 3.2 Edit / Preview 전환 (Alt+P)
- **Edit**: 원본 텍스트 편집
- **Preview**: 변수 치환 결과 렌더링  
  - 변수 하이라이트 옵션에 따라 표시가 달라집니다(3.5 참조)

### 3.3 정리(포맷) 기능(✨)
- 줄 끝 공백 제거
- 3줄 이상 연속 개행을 2줄로 축소
- 전체 텍스트 앞/뒤 공백 제거

---

## 4. 변수 시스템(Variables)

### 4.1 변수 분류(3계층)
1) **시스템 변수(System)**: 런타임 주입 대상(프로토타입에서는 더미 값 치환)
   - `{{chat_thread}}` : 대화 스레드(JSON)
   - `{{last_response}}` : 마지막 응답
   - `{{current_time}}` : 현재 시간(ISO 8601)
   - `{{active_services}}` : 활성 서비스 목록 예: openai/anthropic/google

2) **전역 변수(Global)**: 모든 프롬프트에 공통 적용
   - 행 단위 추가/수정/삭제
   - localStorage에 독립 저장(`smc_global_vars_v1`)
   - 초기 시드: `output_format`, `role`, `lang`

3) **개별 변수(Local)**: 선택된 프롬프트에만 적용
   - 프롬프트 데이터 내 `localVars` 배열로 함께 저장

### 4.2 빠른 삽입(Chips)
- 우측 패널에서 변수들을 칩 형태로 노출
- 클릭 시 에디터 커서 위치에 `{{변수명}}` 형태로 삽입

### 4.3 변수 삽입 팔레트(⚡)
- “⚡ 변수 삽입” 버튼으로 전체 변수 목록을 드롭다운/팔레트 형태로 표시
- 선택 시 커서 위치에 삽입

### 4.4 변수 자동완성(Autocomplete)
- **트리거**: 에디터에서 `{{` 입력 시
- **표시 위치**: 캐럿(커서) 근처
- **그룹화**: 시스템(🔧) / 전역(🌐) / 개별(📌)
- **필터링**: 입력 중인 접두 문자열로 실시간 필터링
- **키보드 조작**
  - ↑/↓ 이동
  - Enter/Tab 선택 삽입
  - Esc 닫기

### 4.5 변수 치환 엔진(템플릿 처리)
- **매칭 패턴**: `{{알파벳/숫자/밑줄}}` 형태
- **변수명 정제(sanitize)**: 특수문자 → `_` 치환, 최대 40자 제한
- **치환 우선순위(의도)**: “현재 프롬프트의 설정이 최종”이 되도록 동작
  - 실사용 관점 권장 우선순위: **시스템 < 전역 < 개별(로컬)**  
    (동일 키가 존재하면 개별 변수가 최종 값을 덮어쓰는 형태)

> 주의: ‘시스템 변수’는 의미상 런타임 주입이므로, 실제 제품화 시에는 시스템 변수가 일반 변수보다 우선하는 정책이 필요할 수 있습니다(보안/무결성 목적). 현재 문서는 **프로토타입 구현 관찰 기반**으로, “현재 프롬프트 설정이 최종”인 사용성을 중심으로 기술했습니다.

### 4.6 Preview 하이라이트 옵션
- **변수 하이라이트 토글**: `{{var}}` 영역을 시각적으로 강조/해제
- **미해결만 강조**: 값이 비어 있는 변수만 별도 강조 표시

---

## 5. Cross Check 전송(프리뷰)

### 5.1 Send (Ctrl+Enter)
- “🚀 Send” 또는 `Ctrl+Enter`로 실행
- 모든 변수를 치환한 **최종 텍스트를 모달로 출력**(실제 외부 전송은 없음)

### 5.2 클립보드 복사
- 모달 내 “Copy” 버튼으로 최종 텍스트 복사
- 성공 시 “Copied!” 피드백 표시

### 5.3 전송 시 자동 저장
- Send 실행 시 미저장 변경이 있으면 자동 저장 후 프리뷰 생성

---

## 6. UI/레이아웃 편의 기능

### 6.1 패널 접기/펼치기
- **사이드바 토글 (Alt+1)**: 접으면 54px로 축소, 제목/검색/목록/푸터 숨김
- **변수 패널 토글 (Alt+2)**: 접으면 54px로 축소, 헤더/본문 숨김

### 6.2 패널 리사이즈(폭 조절)
- **사이드바**: 240px ~ 520px 범위 드래그 조절
- **변수 패널**: 280px ~ 520px 범위 드래그 조절
- 조절 값은 localStorage에 저장되어 새로고침 후 유지

### 6.3 Zen 모드(Alt+Z)
- 사이드바와 변수 패널을 동시에 접어 에디터 영역을 최대화
- More 메뉴(⋯) 또는 단축키로 토글
- UI 상태 저장/복원

### 6.4 More 메뉴(⋯)
- Zen / Duplicate / Delete 및 단축키 힌트를 제공
- 외부 클릭 시 닫힘

### 6.5 반응형 처리
- 화면 폭이 좁을 때(예: 980px 이하) 변수 패널 숨김 등 레이아웃 단순화

---

## 7. 키보드 단축키

| 단축키 | 기능 |
|---|---|
| Ctrl+S | 저장(Save) |
| Ctrl+Enter | Send(전송 프리뷰 모달) |
| Alt+1 | 사이드바 접기/펼치기 |
| Alt+2 | 변수 패널 접기/펼치기 |
| Alt+P | Edit/Preview 전환 |
| Alt+Z | Zen 모드 |
| Alt+D | Duplicate |
| Alt+N | New |
| Alt+Backspace | Delete |

---

## 8. 데이터 영속성(Persistence)

### 8.1 localStorage 키(대표)
- `smc_prompts_v1`: 프롬프트 배열  
  (`id`, `title`, `content`, `localVars`, `createdAt`, `updatedAt`, `lastUsedAt`)
- `smc_global_vars_v1`: 전역 변수 배열 (`name`, `value`)
- `smc_ui_v1`: UI 상태(패널 접힘 여부/너비/정렬/Zen 등)

### 8.2 디바운스 저장
- 프롬프트/전역 변수 저장에 약 250ms 디바운스 적용(입력 연속 시 성능 보호)

### 8.3 beforeunload 자동 저장
- 브라우저 탭/창 종료 시 미저장 변경이 있으면 자동 저장

### 8.4 시드 데이터(초기 제공)
- 프롬프트가 비어 있으면 샘플 프롬프트 2개 자동 생성  
  (예: “Fact Check 프롬프트”, “천재적 사고 모드”)
- 전역 변수가 없으면 기본 전역 변수 3개 자동 생성  
  (`output_format`, `role`, `lang`)

---

## 9. 기능 간 연계 시나리오(요약)

1) 새 프롬프트 생성 → 제목/내용 작성 → `{{` 입력으로 변수 자동완성 → 전역/개별 변수 값 채움  
2) Preview로 치환 결과 확인(미해결 강조로 누락 검출)  
3) Send로 최종 결과 모달 확인 및 Copy로 외부 도구에 붙여넣기  
4) Import/Export로 백업/공유(덮어쓰기 주의)

---

## 10. 프로토타입 한계 및 제품화 시 고려(간단 메모)

- **전송은 프리뷰 단계**이므로, 실제 “Cross Check(다중 모델/다중 서비스 전송)”을 하려면  
  서비스 커넥터, 요청/응답 저장, 실행 이력(런 로그) 및 권한/RBAC가 추가로 필요합니다.
- 시스템 변수(`chat_thread`, `last_response`)는 실제 제품에서는 **민감 정보**를 포함할 수 있어  
  마스킹/필터링/접근제어 정책이 필요합니다.
